<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Class: PhusionPassenger::AbstractRequestHandler</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Class</span><br />PhusionPassenger::AbstractRequestHandler</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../files/lib/phusion_passenger/abstract_request_handler_rb.html">lib/phusion_passenger/abstract_request_handler.rb</a>
        </td>
      </tr>
    <tr>
      <td>Parent:</td>
      <td>
Object
     </td>
   </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
The request handler is the layer which connects Apache with the underlying
application&#8216;s request dispatcher (i.e. either Rails&#8216;s
Dispatcher class or <a href="Rack.html">Rack</a>). The request
handler&#8216;s job is to process incoming HTTP requests using the
currently loaded Ruby on Rails application. HTTP requests are forwarded to
the request handler by the web server. HTTP responses generated by the RoR
application are forwarded to the web server, which, in turn, sends the
response back to the HTTP client.
</p>
<p>
<a href="AbstractRequestHandler.html">AbstractRequestHandler</a> is an
abstract base class for easing the implementation of request handlers for
Rails and <a href="Rack.html">Rack</a>.
</p>
<h2>Design decisions</h2>
<p>
Some design decisions are made because we want to decrease system
administrator maintenance overhead. These decisions are documented in this
section.
</p>
<h3>Owner pipes</h3>
<p>
Because only the web server communicates directly with a request handler,
we want the request handler to exit if the web server has also exited. This
is implemented by using a so-called _owner pipe_. The writable part of the
pipe will be passed to the web server* via a Unix socket, and the web
server will own that part of the pipe, while <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> owns the
readable part of the pipe. <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> will
continuously check whether the other side of the pipe has been closed. If
so, then it knows that the web server has exited, and so the request
handler will exit as well. This works even if the web server gets killed by
SIGKILL.
</p>
<ul>
<li>It might also be passed to the ApplicationPoolServerExecutable, if the web
server&#8216;s using ApplicationPoolServer instead of
StandardApplicationPool.

</li>
</ul>
<h2>Request format</h2>
<p>
Incoming &quot;HTTP requests&quot; are not true HTTP requests, i.e. their
binary representation do not conform to RFC 2616. Instead, the request
format is based on CGI, and is similar to that of SCGI.
</p>
<p>
The format consists of 3 parts:
</p>
<ul>
<li>A 32-bit big-endian integer, containing the size of the transformed
headers.

</li>
<li>The transformed HTTP headers.

</li>
<li>The verbatim (untransformed) HTTP request body.

</li>
</ul>
<p>
HTTP headers are transformed to a format that satisfies the following
grammar:
</p>
<pre>
 headers ::= header*
 header ::= name NUL value NUL
 name ::= notnull+
 value ::= notnull+
 notnull ::= &quot;\x01&quot; | &quot;\x02&quot; | &quot;\x02&quot; | ... | &quot;\xFF&quot;
 NUL = &quot;\x00&quot;
</pre>
<p>
The web server transforms the HTTP request to the aforementioned format,
and sends it to the request handler.
</p>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000125">cleanup</a></li>
  <li><a href="#M000127">main_loop</a></li>
  <li><a href="#M000126">main_loop_running?</a></li>
  <li><a href="#M000124">new</a></li>
  <li><a href="#M000128">start_main_loop_thread</a></li>
  </ul>

<div class="sectiontitle">Included Modules</div>
<ul>
  <li><a href="Utils.html">Utils</a></li>
</ul>



  <div class="sectiontitle">Constants</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class="attr-name">HARD_TERMINATION_SIGNAL</td>
    <td>=</td>
    <td class="attr-value">&quot;SIGTERM&quot;</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
<a href="../Signal.html">Signal</a> which will cause the Rails application
to exit immediately.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">SOFT_TERMINATION_SIGNAL</td>
    <td>=</td>
    <td class="attr-value">&quot;SIGUSR1&quot;</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
<a href="../Signal.html">Signal</a> which will cause the Rails application
to exit as soon as it&#8216;s done processing a request.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">BACKLOG_SIZE</td>
    <td>=</td>
    <td class="attr-value">100</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">MAX_HEADER_SIZE</td>
    <td>=</td>
    <td class="attr-value">128 * 1024</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">PASSENGER_HEADER</td>
    <td>=</td>
    <td class="attr-value">determine_passenger_header</td>
  </tr>
  </table>

  <div class="sectiontitle">Attributes</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>iterations</td>
    <td class='attr-desc'>
The number of times the main loop has iterated so far. Mostly useful for
unit test assertions.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[RW]
    </td>
    <td class='attr-name'>memory_limit</td>
    <td class='attr-desc'>
Specifies the maximum allowed memory usage, in MB. If after having
processed a request <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> detects that
memory usage has risen above this limit, then it will gracefully exit (that
is, exit after having processed all pending requests).

<p>
A value of 0 (the default) indicates that there&#8216;s no limit.
</p>
</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>processed_requests</td>
    <td class='attr-desc'>
Number of requests processed so far. This includes requests that raised
exceptions.

</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>socket_name</td>
    <td class='attr-desc'>
The name of the socket on which the request handler accepts <a
href="AbstractRequestHandler.html#M000124">new</a> connections. At this
moment, this value is always the filename of a Unix domain socket.

<p>
See also #socket_type.
</p>
</td>
  </tr>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>socket_type</td>
    <td class='attr-desc'>
The type of socket that #socket_name refers to. At the moment, the value is
always &#8216;unix&#8217;, which indicates a Unix domain socket.

</td>
  </tr>
  </table>

<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000124"></a><b>new</b>(owner_pipe, options = {})
  </div>
  <div class="description">
  <p>
Create a <a href="AbstractRequestHandler.html#M000124">new</a>
RequestHandler with the given owner pipe. <tt>owner_pipe</tt> must be the
readable part of a pipe <a href="../IO.html">IO</a> object.
</p>
<p>
Additionally, the following options may be given:
</p>
<ul>
<li>memory_limit: Used to set the <tt>memory_limit</tt> attribute.

</li>
</ul>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000124_source')" id="l_M000124_source">show source</a> ]</p>
  <div id="M000124_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 137</span>
137:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">owner_pipe</span>, <span class="ruby-identifier">options</span> = {})
138:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">should_use_unix_sockets?</span>
139:                         <span class="ruby-identifier">create_unix_socket_on_filesystem</span>
140:                 <span class="ruby-keyword kw">else</span>
141:                         <span class="ruby-identifier">create_tcp_socket</span>
142:                 <span class="ruby-keyword kw">end</span>
143:                 <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">close_on_exec!</span>
144:                 <span class="ruby-ivar">@owner_pipe</span> = <span class="ruby-identifier">owner_pipe</span>
145:                 <span class="ruby-ivar">@previous_signal_handlers</span> = {}
146:                 <span class="ruby-ivar">@main_loop_generation</span>  = <span class="ruby-value">0</span>
147:                 <span class="ruby-ivar">@main_loop_thread_lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
148:                 <span class="ruby-ivar">@main_loop_thread_cond</span> = <span class="ruby-constant">ConditionVariable</span>.<span class="ruby-identifier">new</span>
149:                 <span class="ruby-ivar">@memory_limit</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;memory_limit&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
150:                 <span class="ruby-ivar">@iterations</span> = <span class="ruby-value">0</span>
151:                 <span class="ruby-ivar">@processed_requests</span> = <span class="ruby-value">0</span>
152:                 <span class="ruby-ivar">@main_loop_running</span> = <span class="ruby-keyword kw">false</span>
153:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000125"></a><b>cleanup</b>()
  </div>
  <div class="description">
  <p>
Clean up temporary stuff created by the request handler.
</p>
<p>
If the main loop was started by <a
href="AbstractRequestHandler.html#M000127">#main_loop</a>, then this method
may only be called after the main loop has exited.
</p>
<p>
If the main loop was started by <a
href="AbstractRequestHandler.html#M000128">#start_main_loop_thread</a>,
then this method may be called at any time, and it will stop the main loop
thread.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000125_source')" id="l_M000125_source">show source</a> ]</p>
  <div id="M000125_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 162</span>
162:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleanup</span>
163:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@main_loop_thread</span>
164:                         <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
165:                                 <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
166:                         <span class="ruby-keyword kw">end</span>
167:                         <span class="ruby-ivar">@main_loop_thread</span>.<span class="ruby-identifier">join</span>
168:                 <span class="ruby-keyword kw">end</span>
169:                 <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
170:                 <span class="ruby-ivar">@owner_pipe</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
171:                 <span class="ruby-constant">File</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-ivar">@socket_name</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
172:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000127"></a><b>main_loop</b>()
  </div>
  <div class="description">
  <p>
Enter the request handler&#8216;s main loop.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000127_source')" id="l_M000127_source">show source</a> ]</p>
  <div id="M000127_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 180</span>
180:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">main_loop</span>
181:                 <span class="ruby-identifier">reset_signal_handlers</span>
182:                 <span class="ruby-keyword kw">begin</span>
183:                         <span class="ruby-ivar">@graceful_termination_pipe</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
184:                         <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">close_on_exec!</span>
185:                         <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close_on_exec!</span>
186:                         
187:                         <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
188:                                 <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
189:                                 <span class="ruby-ivar">@main_loop_running</span> = <span class="ruby-keyword kw">true</span>
190:                                 <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">broadcast</span>
191:                         <span class="ruby-keyword kw">end</span>
192:                         
193:                         <span class="ruby-identifier">install_useful_signal_handlers</span>
194:                         
195:                         <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
196:                                 <span class="ruby-ivar">@iterations</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
197:                                 <span class="ruby-identifier">client</span> = <span class="ruby-identifier">accept_connection</span>
198:                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">nil?</span>
199:                                         <span class="ruby-keyword kw">break</span>
200:                                 <span class="ruby-keyword kw">end</span>
201:                                 <span class="ruby-keyword kw">begin</span>
202:                                         <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input</span> = <span class="ruby-identifier">parse_request</span>(<span class="ruby-identifier">client</span>)
203:                                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">headers</span>
204:                                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">headers</span>[<span class="ruby-constant">REQUEST_METHOD</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">PING</span>
205:                                                         <span class="ruby-identifier">process_ping</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input</span>, <span class="ruby-identifier">client</span>)
206:                                                 <span class="ruby-keyword kw">else</span>
207:                                                         <span class="ruby-identifier">process_request</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input</span>, <span class="ruby-identifier">client</span>)
208:                                                 <span class="ruby-keyword kw">end</span>
209:                                         <span class="ruby-keyword kw">end</span>
210:                                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">IOError</span>, <span class="ruby-constant">SocketError</span>, <span class="ruby-constant">SystemCallError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
211:                                         <span class="ruby-identifier">print_exception</span>(<span class="ruby-value str">&quot;Passenger RequestHandler&quot;</span>, <span class="ruby-identifier">e</span>)
212:                                 <span class="ruby-keyword kw">ensure</span>
213:                                         <span class="ruby-comment cmt"># 'input' is the same as 'client' so we don't</span>
214:                                         <span class="ruby-comment cmt"># need to close that.</span>
215:                                         <span class="ruby-comment cmt"># The 'close_write' here prevents forked child</span>
216:                                         <span class="ruby-comment cmt"># processes from unintentionally keeping the</span>
217:                                         <span class="ruby-comment cmt"># connection open.</span>
218:                                         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">close_write</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
219:                                         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
220:                                 <span class="ruby-keyword kw">end</span>
221:                                 <span class="ruby-ivar">@processed_requests</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
222:                         <span class="ruby-keyword kw">end</span>
223:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
224:                         <span class="ruby-comment cmt"># Exit main loop.</span>
225:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Interrupt</span>
226:                         <span class="ruby-comment cmt"># Exit main loop.</span>
227:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">signal</span>
228:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">signal</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">HARD_TERMINATION_SIGNAL</span> <span class="ruby-operator">&amp;&amp;</span>
229:                            <span class="ruby-identifier">signal</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span>
230:                                 <span class="ruby-identifier">raise</span>
231:                         <span class="ruby-keyword kw">end</span>
232:                 <span class="ruby-keyword kw">ensure</span>
233:                         <span class="ruby-identifier">revert_signal_handlers</span>
234:                         <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
235:                                 <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
236:                                 <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
237:                                 <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
238:                                 <span class="ruby-ivar">@main_loop_running</span> = <span class="ruby-keyword kw">false</span>
239:                                 <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">broadcast</span>
240:                         <span class="ruby-keyword kw">end</span>
241:                 <span class="ruby-keyword kw">end</span>
242:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000126"></a><b>main_loop_running?</b>()
  </div>
  <div class="description">
  <p>
Check whether the main loop&#8216;s currently running.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000126_source')" id="l_M000126_source">show source</a> ]</p>
  <div id="M000126_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 175</span>
175:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">main_loop_running?</span>
176:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@main_loop_running</span>
177:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000128"></a><b>start_main_loop_thread</b>()
  </div>
  <div class="description">
  <p>
Start the main loop in a <a
href="AbstractRequestHandler.html#M000124">new</a> thread. This thread will
be stopped by <a href="AbstractRequestHandler.html#M000125">#cleanup</a>.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000128_source')" id="l_M000128_source">show source</a> ]</p>
  <div id="M000128_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 245</span>
245:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_main_loop_thread</span>
246:                 <span class="ruby-identifier">current_generation</span> = <span class="ruby-ivar">@main_loop_generation</span>
247:                 <span class="ruby-ivar">@main_loop_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
248:                         <span class="ruby-identifier">main_loop</span>
249:                 <span class="ruby-keyword kw">end</span>
250:                 <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
251:                         <span class="ruby-keyword kw">while</span> <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_generation</span>
252:                                 <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">wait</span>(<span class="ruby-ivar">@main_loop_thread_lock</span>)
253:                         <span class="ruby-keyword kw">end</span>
254:                 <span class="ruby-keyword kw">end</span>
255:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>